<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„³ãƒˆãƒ¬ï¼ä»²é–“ã¯ãšã‚Œæ¢ã—ï¼ˆè¨˜éŒ²æ©Ÿèƒ½ä»˜ï¼‰</title>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            text-align: center;
            background-color: #f3e5f5; /* è–„ã„ç´« */
            user-select: none;
            margin: 0;
            padding: 10px;
            padding-bottom: 50px;
        }

        h1 { color: #8e24aa; margin: 10px 0; font-size: 24px; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
        .status-board {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .score-box { color: #d32f2f; }
        .time-box { color: #1976d2; }

        /* ã‚²ãƒ¼ãƒ ç›¤ */
        #game-grid {
            display: grid;
            gap: 5px;
            margin: 0 auto;
            justify-content: center;
            max-width: 360px; /* ã‚¹ãƒãƒ›å¹… */
        }

        /* ãƒ‘ãƒãƒ«ï¼ˆãƒœã‚¿ãƒ³ï¼‰ */
        .panel {
            background-color: white;
            border: 2px solid #ce93d8;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px; /* çµµæ–‡å­—ã‚µã‚¤ã‚º */
            aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ */
            transition: transform 0.1s;
            box-shadow: 0 4px #ba68c8;
        }
        
        .panel:active {
            transform: scale(0.95);
            box-shadow: 0 2px #ba68c8;
        }

        /* ä¸æ­£è§£ã®æ™‚ã®æºã‚Œ */
        .shake {
            animation: shake 0.3s;
            background-color: #cfcfcf !important;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        #start-btn {
            font-size: 24px;
            padding: 12px 60px;
            background-color: #ab47bc;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #7b1fa2;
            margin-top: 20px;
        }
        #start-btn:active { transform: translateY(2px); box-shadow: 0 2px #7b1fa2; }

        /* --- çµæœç”»é¢ --- */
        #result-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8); z-index: 999;
            justify-content: center; align-items: center;
        }
        .result-box {
            background-color: white; padding: 25px; width: 85%; max-width: 350px;
            border-radius: 15px; text-align: center;
        }
        .result-score { font-size: 40px; color: #d32f2f; font-weight: bold; margin: 10px 0; }
        .ranking-title { font-size: 18px; color: #e65100; margin-top: 15px; border-bottom: 2px solid #ffcc80; display: inline-block; }
        ul { list-style: none; padding: 0; margin: 10px 0; text-align: left; }
        li { padding: 6px 10px; border-bottom: 1px dotted #ccc; font-size: 16px; }
        li.rank-1 { color: #d84315; font-weight: bold; background-color: #fff3e0; }
        
        #retry-btn {
            background-color: #42a5f5; color: white; font-size: 18px; padding: 10px 30px;
            border: none; border-radius: 30px; margin-top: 15px; cursor: pointer; width: 80%;
        }
        #reset-storage {
            font-size: 12px; color: #999; margin-top: 15px; background: none; border: none; text-decoration: underline; cursor: pointer;
        }

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-link { display: block; margin-top: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

    <h1>ğŸ‘€ ä»²é–“ã¯ãšã‚Œæ¢ã—</h1>
    <div class="status-board">
        <div class="score-box">æ­£è§£æ•°: <span id="score">0</span></div>
        <div class="time-box">æ®‹ã‚Š: <span id="timer">60</span>ç§’</div>
    </div>

    <button id="start-btn">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>

    <div id="game-grid">
        </div>

    <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

    <div id="result-overlay">
        <div class="result-box">
            <h2>æ™‚é–“åˆ‡ã‚Œï¼</h2>
            <div>è¦‹ã¤ã‘ãŸæ•°</div>
            <div class="result-score" id="final-score">0å€‹</div>
            <div id="sending-msg" style="font-size:12px; color:blue;">è¨˜éŒ²ä¸­...</div>
            
            <div class="ranking-title">ğŸ† è¦³å¯ŸåŠ›ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</div>
            <ul id="overlay-ranking-list"></ul>

            <button id="retry-btn">ã‚‚ã†ä¸€å›æŒ‘æˆ¦</button>
            <br>
            <button id="reset-storage">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="common.js"></script>

    <script>
        window.onload = function() {
            const grid = document.getElementById('game-grid');
            const scoreDisplay = document.getElementById('score');
            const timerDisplay = document.getElementById('timer');
            const startBtn = document.getElementById('start-btn');
            
            // çµæœç”»é¢ç”¨
            const resultOverlay = document.getElementById('result-overlay');
            const finalScoreDisplay = document.getElementById('final-score');
            const rankingList = document.getElementById('overlay-ranking-list');
            const retryBtn = document.getElementById('retry-btn');
            const resetBtn = document.getElementById('reset-storage');
            const sendingMsg = document.getElementById('sending-msg');

            let score = 0;
            let timeLeft = 60;
            let timerInterval;
            let isPlaying = false;
            let currentLevel = 2; // ã‚°ãƒªãƒƒãƒ‰ã®ã‚µã‚¤ã‚ºï¼ˆ2x2ã‹ã‚‰é–‹å§‹ï¼‰

            const STORAGE_KEY = 'odd_one_ranking_v1';

            // å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆ[é€šå¸¸, ä»²é–“ã¯ãšã‚Œ] ã®ãƒšã‚¢ï¼‰
            const pairs = [
                ['ğŸ±', 'ğŸ¯'], ['ğŸ¶', 'ğŸº'], ['ğŸ', 'ğŸ…'], ['âš½ï¸', 'ğŸ€'],
                ['ğŸš—', 'ğŸš•'], ['ğŸ˜€', 'ğŸ˜ƒ'], ['ğŸŒ™', 'ğŸŒœ'], ['âŒšï¸', 'â°'],
                ['ğŸ‘“', 'ğŸ•¶'], ['ğŸ¦', 'ğŸ§'], ['ğŸŒ²', 'ğŸŒ³'], ['ğŸ ', 'ğŸ¡'],
                ['ğŸš„', 'ğŸš…'], ['âœï¸', 'âœ’ï¸'], ['ğŸ””', 'ğŸ”•'], ['ğŸ”’', 'ğŸ”“']
            ];

            function startGame() {
                score = 0;
                timeLeft = 60;
                currentLevel = 2; // æœ€åˆã¯2x2
                scoreDisplay.textContent = 0;
                timerDisplay.textContent = 60;
                startBtn.style.display = 'none';
                isPlaying = true;

                generateLevel();

                // ã‚¿ã‚¤ãƒãƒ¼
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function generateLevel() {
                grid.innerHTML = "";

                // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºæ±ºå®šï¼ˆæœ€å¤§5x5ã¾ã§ï¼‰
                // ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦é›£æ˜“åº¦ã‚¢ãƒƒãƒ—
                if (score >= 3) currentLevel = 3;
                if (score >= 8) currentLevel = 4;
                if (score >= 15) currentLevel = 5;

                // ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã‚µã‚¤ã‚ºèª¿æ•´
                grid.style.gridTemplateColumns = `repeat(${currentLevel}, 1fr)`;
                
                const totalCells = currentLevel * currentLevel;
                
                // ãƒšã‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
                const pair = pairs[Math.floor(Math.random() * pairs.length)];
                const normalChar = pair[0];
                const oddChar = pair[1];

                // ä»²é–“ã¯ãšã‚Œã®å ´æ‰€ã‚’æ±ºã‚ã‚‹
                const oddIndex = Math.floor(Math.random() * totalCells);

                // ãƒ‘ãƒãƒ«ç”Ÿæˆ
                for (let i = 0; i < totalCells; i++) {
                    const div = document.createElement('div');
                    div.className = 'panel';
                    
                    if (i === oddIndex) {
                        div.textContent = oddChar; // æ­£è§£
                        div.onclick = () => handleCorrect();
                    } else {
                        div.textContent = normalChar; // é–“é•ã„
                        div.onclick = (e) => handleWrong(e.target);
                    }

                    // æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆæ•°ãŒå¢—ãˆã‚‹ã¨å°ã•ãã™ã‚‹ï¼‰
                    if (currentLevel >= 5) div.style.fontSize = "28px";
                    else div.style.fontSize = "40px";

                    grid.appendChild(div);
                }
            }

            function handleCorrect() {
                if (!isPlaying) return;
                score++;
                scoreDisplay.textContent = score;
                generateLevel(); // æ¬¡ã®å•é¡Œã¸
            }

            function handleWrong(element) {
                if (!isPlaying) return;
                // é–“é•ãˆãŸã‚‰æºã‚‰ã™
                element.classList.add('shake');
                setTimeout(() => {
                    element.classList.remove('shake');
                }, 300);
            }

            function endGame() {
                clearInterval(timerInterval);
                isPlaying = false;
                finalScoreDisplay.textContent = score + "å€‹";
                saveAndShowRanking(score);
                resultOverlay.style.display = "flex";
            }

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼†è¨˜éŒ²å‡¦ç†
            function saveAndShowRanking(newScore) {
                // 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡
                if (typeof sendData === 'function') {
                    sendingMsg.textContent = "è¨˜éŒ²ä¸­...";
                    sendData("ä»²é–“ã¯ãšã‚Œ", newScore);
                    setTimeout(() => { sendingMsg.textContent = "âœ… è¨˜éŒ²å®Œäº†"; }, 1000);
                }

                // 2. ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                let scores = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
                scores.push(newScore);
                scores.sort((a, b) => b - a); // å¤šã„é †
                scores = scores.slice(0, 5);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));

                let html = "";
                if (scores.length === 0) html = "<li>è¨˜éŒ²ãªã—</li>";
                else {
                    scores.forEach((s, i) => {
                        let rankClass = i === 0 ? 'class="rank-1"' : '';
                        let icon = i === 0 ? 'ğŸ‘‘' : (i + 1) + 'ä½';
                        html += `<li ${rankClass}>${icon} : ${s} å€‹</li>`;
                    });
                }
                rankingList.innerHTML = html;
            }

            startBtn.addEventListener('click', startGame);
            retryBtn.addEventListener('click', () => {
                resultOverlay.style.display = "none";
                grid.innerHTML = "";
                startBtn.style.display = "inline-block";
                scoreDisplay.textContent = 0;
                timerDisplay.textContent = 60;
            });
            resetBtn.addEventListener('click', () => {
                if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                    resultOverlay.style.display = "none";
                    startBtn.style.display = "inline-block";
                }
            });
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ„Ÿï¼ãªã‚‰ã¹ã‹ãˆãƒ‘ã‚ºãƒ«ï¼ˆè¨˜éŒ²æ©Ÿèƒ½ä»˜ï¼‰</title>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            text-align: center;
            background-color: #fffde7; /* è–„ã„é»„è‰² */
            user-select: none;
            margin: 0;
            padding: 10px;
            padding-bottom: 50px;
        }

        h1 { color: #fbc02d; margin: 10px 0; font-size: 22px; text-shadow: 1px 1px 0 #fff; }
        p { font-size: 16px; color: #555; margin: 5px; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-board {
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        /* ãƒ‘ã‚ºãƒ«ã®æ ï¼ˆ3x3ï¼‰ */
        #puzzle-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            width: 300px; /* ã‚¹ãƒãƒ›ã«åã¾ã‚‹ã‚µã‚¤ã‚º */
            margin: 0 auto;
            background-color: #ccc;
            padding: 5px;
            border-radius: 10px;
        }

        /* ãƒ”ãƒ¼ã‚¹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .piece {
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: bold;
            color: rgba(255,255,255, 0.9);
            text-shadow: 0 2px 2px rgba(0,0,0,0.2);
            cursor: pointer;
            border-radius: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* é¸æŠä¸­ã®ãƒ”ãƒ¼ã‚¹ */
        .piece.selected {
            transform: scale(0.9);
            box-shadow: 0 0 0 4px #333 inset; /* å†…å´ã«é»’ã„æ  */
            z-index: 10;
        }

        /* å®Œæˆæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .piece.solved {
            border: none;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        #start-btn {
            font-size: 22px;
            padding: 12px 50px;
            background-color: #8bc34a;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #558b2f;
            margin-top: 25px;
        }
        #start-btn:active { transform: translateY(2px); box-shadow: 0 2px #558b2f; }

        /* --- çµæœç™ºè¡¨ç”»é¢ --- */
        #result-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        .result-box {
            background-color: white;
            padding: 25px;
            width: 85%;
            max-width: 350px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .result-time { font-size: 36px; color: #fbc02d; font-weight: bold; margin: 10px 0; }
        
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ */
        .ranking-title { font-size: 18px; color: #e65100; margin-top: 15px; border-bottom: 2px solid #ffe082; display: inline-block; }
        ul { list-style: none; padding: 0; margin: 10px 0; text-align: left; }
        li { padding: 6px 10px; border-bottom: 1px dotted #ccc; font-size: 16px; }
        li.rank-1 { color: #d84315; font-weight: bold; background-color: #fff3e0; }

        #retry-btn {
            background-color: #03a9f4; color: white; font-size: 18px; padding: 10px 30px;
            border: none; border-radius: 30px; margin-top: 15px; cursor: pointer; width: 80%;
        }
        #reset-storage {
            font-size: 12px; color: #999; margin-top: 15px; background: none; border: none; text-decoration: underline; cursor: pointer;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-link { display: block; margin-top: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

    <h1>ğŸŒˆ è‰²ä¸¦ã¹ãƒ‘ã‚ºãƒ«</h1>
    <p>1ã‹ã‚‰9ã¾ã§é †ç•ªã«ä¸¦ã¹ã¦ã­</p>

    <div class="status-board">
        â± ã‚¿ã‚¤ãƒ : <span id="timer">0.0</span> ç§’
    </div>

    <div id="puzzle-container">
        </div>

    <button id="start-btn">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>

    <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

    <div id="result-overlay">
        <div class="result-box">
            <h2>ğŸŒˆ å®Œæˆï¼ ğŸŒˆ</h2>
            <div>ã‹ã‹ã£ãŸæ™‚é–“</div>
            <div class="result-time" id="final-time">0.0ç§’</div>
            <div id="sending-msg" style="font-size:12px; color:blue;">è¨˜éŒ²ä¸­...</div>
            
            <div class="ranking-title">ğŸ† æ—©ä¸¦ã¹ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</div>
            <ul id="overlay-ranking-list"></ul>

            <button id="retry-btn">ã‚‚ã†ä¸€å›éŠã¶</button>
            <br>
            <button id="reset-storage">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="common.js"></script>

    <script>
        window.onload = function() {
            const container = document.getElementById('puzzle-container');
            const timerDisplay = document.getElementById('timer');
            const startBtn = document.getElementById('start-btn');
            
            // çµæœç”»é¢ç”¨
            const resultOverlay = document.getElementById('result-overlay');
            const finalTimeDisplay = document.getElementById('final-time');
            const rankingList = document.getElementById('overlay-ranking-list');
            const retryBtn = document.getElementById('retry-btn');
            const resetBtn = document.getElementById('reset-storage');
            const sendingMsg = document.getElementById('sending-msg');

            let pieces = []; // ä»Šã®ä¸¦ã³é †ï¼ˆæ•°å­—ã®é…åˆ—ï¼‰
            let selectedIndex = null; // æœ€åˆã«ã‚¿ãƒƒãƒã—ãŸå ´æ‰€
            let isPlaying = false;
            let startTime;
            let timerInterval;
            
            const STORAGE_KEY = 'puzzle_ranking_v1';

            // è‰²ã®ãƒªã‚¹ãƒˆï¼ˆ1ã€œ9ã«å¯¾å¿œã™ã‚‹ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è‰²ï¼‰
            const colors = [
                "#ef5350", "#ff7043", "#ffca28", "#d4e157", "#66bb6a", "#26a69a", "#42a5f5", "#5c6bc0", "#ab47bc"
            ];

            // åˆæœŸè¡¨ç¤ºï¼ˆæ•´åˆ—ã—ãŸçŠ¶æ…‹ã§è¦‹ã›ã‚‹ï¼‰
            renderPuzzle([1,2,3,4,5,6,7,8,9], false);

            // ã‚²ãƒ¼ãƒ é–‹å§‹
            function startGame() {
                startBtn.style.display = "none";
                isPlaying = true;
                selectedIndex = null;
                timerDisplay.textContent = "0.0";
                
                pieces = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                do {
                    pieces.sort(() => Math.random() - 0.5);
                } while (checkWin(pieces)); // æœ€åˆã‹ã‚‰æƒã£ã¦ã„ãŸã‚‰ã‚„ã‚Šç›´ã—

                renderPuzzle(pieces, true);

                // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const now = Date.now();
                    timerDisplay.textContent = ((now - startTime) / 1000).toFixed(1);
                }, 100);
            }

            // ãƒ‘ã‚ºãƒ«ã‚’æç”»ã™ã‚‹é–¢æ•°
            function renderPuzzle(arr, clickable) {
                container.innerHTML = "";
                arr.forEach((num, index) => {
                    const div = document.createElement('div');
                    div.className = 'piece';
                    div.textContent = num;
                    div.style.backgroundColor = colors[num - 1];

                    if (clickable) {
                        div.onclick = () => handleTap(index);
                        if (index === selectedIndex) {
                            div.classList.add('selected');
                        }
                    }
                    container.appendChild(div);
                });
            }

            // ã‚¿ãƒƒãƒ—å‡¦ç†
            function handleTap(index) {
                if (!isPlaying) return;

                if (selectedIndex === null) {
                    selectedIndex = index;
                    renderPuzzle(pieces, true);
                } else if (selectedIndex === index) {
                    selectedIndex = null;
                    renderPuzzle(pieces, true);
                } else {
                    swapPieces(selectedIndex, index);
                    selectedIndex = null;
                    
                    if (checkWin(pieces)) {
                        renderPuzzle(pieces, false); // æ“ä½œä¸å¯ã«ã™ã‚‹
                        gameClear();
                    } else {
                        renderPuzzle(pieces, true);
                    }
                }
            }

            function swapPieces(idx1, idx2) {
                const temp = pieces[idx1];
                pieces[idx1] = pieces[idx2];
                pieces[idx2] = temp;
            }

            function checkWin(arr) {
                for (let i = 0; i < arr.length; i++) {
                    if (arr[i] !== i + 1) return false;
                }
                return true;
            }

            function gameClear() {
                clearInterval(timerInterval);
                isPlaying = false;
                const finalTime = timerDisplay.textContent;
                
                setTimeout(() => {
                    finalTimeDisplay.textContent = finalTime + " ç§’";
                    saveAndShowRanking(finalTime);
                    resultOverlay.style.display = "flex";
                }, 500);
            }

            // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼†è¨˜éŒ²å‡¦ç† ---
            function saveAndShowRanking(timeStr) {
                // 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡
                if (typeof sendData === 'function') {
                    sendingMsg.textContent = "è¨˜éŒ²ä¸­...";
                    sendData("è‰²ä¸¦ã¹ãƒ‘ã‚ºãƒ«", timeStr);
                    setTimeout(() => { sendingMsg.textContent = "âœ… è¨˜éŒ²å®Œäº†"; }, 1000);
                }

                // 2. ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                let scores = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
                scores.push(parseFloat(timeStr));
                scores.sort((a, b) => a - b); // ã‚¿ã‚¤ãƒ ã¯å°ã•ã„é †
                scores = scores.slice(0, 5);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));

                let html = "";
                if (scores.length === 0) html = "<li>è¨˜éŒ²ãªã—</li>";
                else {
                    scores.forEach((t, i) => {
                        let rankClass = i === 0 ? 'class="rank-1"' : '';
                        let icon = i === 0 ? 'ğŸ‘‘' : (i + 1) + 'ä½';
                        html += `<li ${rankClass}>${icon} : ${t.toFixed(1)} ç§’</li>`;
                    });
                }
                rankingList.innerHTML = html;
            }

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            startBtn.addEventListener('click', startGame);
            
            retryBtn.addEventListener('click', () => {
                resultOverlay.style.display = "none";
                startBtn.style.display = "inline-block";
                startBtn.textContent = "ã‚‚ã†ä¸€å›éŠã¶";
                renderPuzzle([1,2,3,4,5,6,7,8,9], false);
                timerDisplay.textContent = "0.0";
            });

            resetBtn.addEventListener('click', () => {
                if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                    resultOverlay.style.display = "none";
                    startBtn.style.display = "inline-block";
                }
            });
        };
    </script>
</body>
</html>
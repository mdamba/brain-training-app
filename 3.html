<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„³ãƒˆãƒ¬ï¼æ•°å­—ã‚¿ãƒƒãƒï¼ˆè¨˜éŒ²æ©Ÿèƒ½ä»˜ï¼‰</title>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            text-align: center;
            background-color: #e0f7fa;
            user-select: none;
            margin: 0;
            padding: 0;
            padding-bottom: 50px;
        }

        h1 { color: #006064; margin: 15px 0 10px 0; font-size: 24px; }

        /* ä¸Šéƒ¨ã®æƒ…å ±ãƒ‘ãƒãƒ« */
        .info-panel {
            background-color: white;
            padding: 10px;
            margin: 0 auto 10px auto;
            width: 90%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .next-box { font-size: 20px; font-weight: bold; color: #d32f2f; }
        .next-number { font-size: 30px; color: #d32f2f; }
        .timer-box { font-size: 20px; color: #006064; font-weight: bold; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        #start-btn {
            font-size: 22px;
            padding: 12px 50px;
            background-color: #ff7043;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #d84315;
            margin: 20px auto;
            display: block;
        }
        #start-btn:active { transform: translateY(2px); box-shadow: 0 2px #d84315; }

        /* ã‚²ãƒ¼ãƒ ç›¤ï¼ˆ5åˆ—x4è¡Œï¼‰ */
        #game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-width: 380px;
            margin: 0 auto;
            padding: 10px;
        }

        /* æ•°å­—ãƒœã‚¿ãƒ³ */
        .num-btn {
            background-color: #4dd0e1;
            color: #006064;
            font-size: 28px;
            font-weight: bold;
            aspect-ratio: 1 / 1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px #0097a7;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.1s;
        }
        .num-btn:active { transform: translateY(2px); box-shadow: 0 2px #0097a7; }
        
        /* æŠ¼ã—ãŸå¾Œã®è¦‹ãŸç›® */
        .num-btn.cleared {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }

        /* --- çµæœç™ºè¡¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
        #result-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .result-box {
            background-color: white;
            padding: 25px;
            width: 85%;
            max-width: 400px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            animation: popIn 0.3s ease-out;
        }
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .result-time { font-size: 36px; color: #d32f2f; font-weight: bold; margin: 10px 0; }
        .ranking-title { font-size: 18px; color: #e65100; margin-top: 20px; border-bottom: 2px solid #ffcc80; display: inline-block; }
        
        ul { list-style: none; padding: 0; margin: 10px 0; text-align: left; }
        li { padding: 8px 10px; border-bottom: 1px dotted #ccc; font-size: 18px; }
        li:last-child { border-bottom: none; }
        
        /* 1ä½ã‚’ç›®ç«‹ãŸã›ã‚‹ */
        li.rank-1 { color: #d84315; font-weight: bold; font-size: 22px; background-color: #fff3e0; border-radius: 5px; }

        #retry-btn {
            background-color: #00bcd4;
            color: white;
            font-size: 20px;
            padding: 10px 30px;
            border: none; border-radius: 30px;
            box-shadow: 0 4px #00838f;
            margin-top: 20px;
            cursor: pointer; width: 80%;
        }
        #retry-btn:active { transform: translateY(2px); box-shadow: 0 2px #00838f; }

        #reset-storage {
            font-size: 12px; color: #999; margin-top: 15px; background: none; border: none; text-decoration: underline; cursor: pointer;
        }

        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-link { display: block; margin-top: 20px; color: #666; text-decoration: none; }

    </style>
</head>
<body>

    <h1>ğŸ‘‡ 1ã‹ã‚‰é †ã«æŠ¼ã—ã¦ï¼ ğŸ‘‡</h1>

    <div class="info-panel">
        <div class="next-box">æ¬¡ã¯: <span id="next-num" class="next-number">-</span></div>
        <div class="timer-box">æ™‚é–“: <span id="timer">0.0</span>ç§’</div>
    </div>

    <button id="start-btn">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>

    <div id="game-grid">
        </div>

    <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

    <div id="result-overlay">
        <div class="result-box">
            <h2>ã‚¯ãƒªã‚¢ï¼</h2>
            <div>ã‚¿ã‚¤ãƒ </div>
            <div class="result-time" id="final-time">0.0ç§’</div>
            <div id="sending-msg" style="font-size:12px; color:blue;">è¨˜éŒ²ä¸­...</div>
            
            <div class="ranking-title">ğŸ† ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</div>
            <ul id="overlay-ranking-list">
                </ul>

            <button id="retry-btn">ã‚‚ã†ä¸€å›éŠã¶</button>
            <br>
            <button id="reset-storage">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="common.js"></script>

    <script>
        window.onload = function() {
            const grid = document.getElementById('game-grid');
            const nextNumDisplay = document.getElementById('next-num');
            const timerDisplay = document.getElementById('timer');
            const startBtn = document.getElementById('start-btn');
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”¨
            const resultOverlay = document.getElementById('result-overlay');
            const finalTimeDisplay = document.getElementById('final-time');
            const overlayRankingList = document.getElementById('overlay-ranking-list');
            const retryBtn = document.getElementById('retry-btn');
            const resetStorageBtn = document.getElementById('reset-storage');
            const sendingMsg = document.getElementById('sending-msg');

            let currentTarget = 1;
            let maxNumber = 20; // ã“ã“ã‚’16ã‚„25ã«å¤‰ãˆã¦é›£æ˜“åº¦èª¿æ•´å¯èƒ½
            let startTime;
            let timerInterval;
            let isPlaying = false;
            let finalTime = 0;

            // ä¿å­˜ã‚­ãƒ¼
            const STORAGE_KEY = 'numbers_ranking_v1';

            // --- ã‚²ãƒ¼ãƒ åˆæœŸåŒ– ---
            function initGame() {
                grid.innerHTML = "";
                resultOverlay.style.display = "none";
                startBtn.style.display = "none";
                
                currentTarget = 1;
                nextNumDisplay.textContent = currentTarget;
                timerDisplay.textContent = "0.0";
                isPlaying = true;

                // æ•°å­—é…åˆ—ä½œæˆ
                let numbers = [];
                for (let i = 1; i <= maxNumber; i++) {
                    numbers.push(i);
                }
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                numbers.sort(() => Math.random() - 0.5);

                // ãƒœã‚¿ãƒ³é…ç½®
                numbers.forEach(num => {
                    const btn = document.createElement('div');
                    btn.classList.add('num-btn');
                    btn.textContent = num;
                    btn.dataset.num = num;

                    // ã‚¿ãƒƒãƒ—æ™‚ã®å‡¦ç†
                    btn.addEventListener('click', () => {
                        if (!isPlaying) return;
                        if (btn.dataset.num == currentTarget) {
                            correctTap(btn);
                        }
                    });
                    grid.appendChild(btn);
                });

                // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const now = Date.now();
                    const diff = (now - startTime) / 1000;
                    timerDisplay.textContent = diff.toFixed(1);
                }, 100);
            }

            // æ­£è§£æ™‚ã®å‡¦ç†
            function correctTap(btn) {
                btn.classList.add('cleared');
                currentTarget++;
                if (currentTarget > maxNumber) {
                    gameClear();
                } else {
                    nextNumDisplay.textContent = currentTarget;
                }
            }

            // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
            function gameClear() {
                clearInterval(timerInterval);
                isPlaying = false;
                
                // æ­£ç¢ºãªæœ€çµ‚ã‚¿ã‚¤ãƒ ã‚’è¨ˆç®—
                const now = Date.now();
                finalTime = ((now - startTime) / 1000).toFixed(1);
                timerDisplay.textContent = finalTime;

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã¨è¡¨ç¤º
                showResult(finalTime);
            }

            // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼†è¨˜éŒ²é–¢é€£ ---
            
            function loadScores() {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [];
            }

            function saveScore(newTimeStr) {
                // 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡
                if (typeof sendData === 'function') {
                    sendingMsg.textContent = "è¨˜éŒ²ä¸­...";
                    sendData("æ•°å­—ã‚¿ãƒƒãƒ", newTimeStr);
                    setTimeout(() => { sendingMsg.textContent = "âœ… è¨˜éŒ²å®Œäº†"; }, 1000);
                }

                // 2. ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                let scores = loadScores();
                let newTime = parseFloat(newTimeStr);
                scores.push(newTime);
                scores.sort((a, b) => a - b); // å°ã•ã„é †ï¼ˆé€Ÿã„é †ï¼‰
                scores = scores.slice(0, 5);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
                return scores;
            }

            function showResult(timeStr) {
                finalTimeDisplay.textContent = timeStr + " ç§’";
                
                // ã‚¹ã‚³ã‚¢ä¿å­˜å®Ÿè¡Œ
                const ranking = saveScore(timeStr);
                
                let html = "";
                if (ranking.length === 0) {
                    html = "<li>è¨˜éŒ²ãªã—</li>";
                } else {
                    ranking.forEach((t, index) => {
                        let rankClass = index === 0 ? 'class="rank-1"' : '';
                        let icon = index === 0 ? 'ğŸ‘‘' : (index + 1) + 'ä½';
                        html += `<li ${rankClass}>${icon} : ${t.toFixed(1)} ç§’</li>`;
                    });
                }
                overlayRankingList.innerHTML = html;
                resultOverlay.style.display = "flex";
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            startBtn.addEventListener('click', initGame);
            
            retryBtn.addEventListener('click', () => {
                resultOverlay.style.display = "none";
                startBtn.style.display = "block"; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã«æˆ»ã‚‹
                startBtn.textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
                grid.innerHTML = ""; // ç›¤é¢ã‚¯ãƒªã‚¢
                timerDisplay.textContent = "0.0";
                nextNumDisplay.textContent = "-";
            });

            resetStorageBtn.addEventListener('click', () => {
                if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å…¨ã¦æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                    resultOverlay.style.display = "none";
                    startBtn.style.display = "block";
                    grid.innerHTML = "";
                }
            });
        };
    </script>
</body>
</html>
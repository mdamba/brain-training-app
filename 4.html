<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è„³ãƒˆãƒ¬ï¼ã‚¹ãƒ”ãƒ¼ãƒ‰è¨ˆç®—ï¼ˆè¨˜éŒ²æ©Ÿèƒ½ä»˜ï¼‰</title>
    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            text-align: center;
            background-color: #fff3e0; /* å„ªã—ã„ã‚ªãƒ¬ãƒ³ã‚¸èƒŒæ™¯ */
            user-select: none;
            margin: 0;
            padding: 10px;
            padding-bottom: 50px;
        }

        h1 { color: #e65100; margin: 10px 0; font-size: 24px; }

        /* ã‚¹ã‚³ã‚¢ãƒ»ã‚¿ã‚¤ãƒãƒ¼æ¿ */
        .status-board {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .score-box { color: #d32f2f; }
        .time-box { color: #1976d2; }

        /* å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #question-area {
            font-size: 50px;
            font-weight: bold;
            color: #333;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            letter-spacing: 5px;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®ã‚¨ãƒªã‚¢ */
        #options-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .option-btn {
            font-size: 32px;
            width: 90px;
            height: 90px;
            border-radius: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px #2E7D32;
            transition: transform 0.1s;
        }
        .option-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px #2E7D32;
        }
        /* é–“é•ãˆãŸæ™‚ã®è‰² */
        .option-btn.wrong {
            background-color: #9e9e9e;
            box-shadow: 0 6px #616161;
            animation: shake 0.3s;
        }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        #start-btn {
            font-size: 24px;
            padding: 12px 60px;
            background-color: #ff5722;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px #bf360c;
        }
        #start-btn:active { transform: translateY(2px); box-shadow: 0 2px #bf360c; }
        #start-btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        /* --- çµæœç™ºè¡¨ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ --- */
        #result-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }

        .result-box {
            background-color: white;
            padding: 25px;
            width: 85%;
            max-width: 400px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }

        .result-score { font-size: 36px; color: #d32f2f; font-weight: bold; margin: 10px 0; }
        .ranking-title { font-size: 18px; color: #e65100; margin-top: 20px; border-bottom: 2px solid #ffcc80; display: inline-block; }
        
        ul { list-style: none; padding: 0; margin: 10px 0; text-align: left; }
        li { padding: 8px 10px; border-bottom: 1px dotted #ccc; font-size: 18px; }
        li.rank-1 { color: #d84315; font-weight: bold; font-size: 22px; background-color: #fff3e0; }

        #retry-btn {
            background-color: #2196F3;
            color: white;
            font-size: 20px;
            padding: 10px 30px;
            border: none; border-radius: 30px;
            box-shadow: 0 4px #0D47A1;
            margin-top: 20px;
            cursor: pointer; width: 80%;
        }
        #reset-storage {
            font-size: 12px; color: #999; margin-top: 15px; background: none; border: none; text-decoration: underline; cursor: pointer;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-link { display: block; margin-top: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

    <h1>ğŸ§® è„³ãƒˆãƒ¬ï¼è¨ˆç®—ãƒ‰ãƒªãƒ«</h1>

    <div class="status-board">
        <div class="score-box">æ­£è§£æ•°: <span id="score">0</span></div>
        <div class="time-box">æ®‹ã‚Š: <span id="timer">30</span>ç§’</div>
    </div>

    <div id="question-area">? + ? = ?</div>

    <div id="options-area">
        <button class="option-btn" id="opt1">-</button>
        <button class="option-btn" id="opt2">-</button>
        <button class="option-btn" id="opt3">-</button>
    </div>

    <button id="start-btn">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    
    <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>

    <div id="result-overlay">
        <div class="result-box">
            <h2>ãŠã¤ã‹ã‚Œã•ã¾ï¼</h2>
            <div>æ­£è§£æ•°</div>
            <div class="result-score" id="final-score">0å•</div>
            <div id="sending-msg" style="font-size:12px; color:blue;">è¨˜éŒ²ä¸­...</div>
            
            <div class="ranking-title">ğŸ† æˆç¸¾ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</div>
            <ul id="overlay-ranking-list"></ul>

            <button id="retry-btn">ã‚‚ã†ä¸€å›æŒ‘æˆ¦</button>
            <br>
            <button id="reset-storage">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»</button>
            <br>
            <a href="index.html" class="back-link">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="common.js"></script>

    <script>
        window.onload = function() {
            // è¦ç´ ã®å–å¾—
            const questionEl = document.getElementById('question-area');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            const startBtn = document.getElementById('start-btn');
            const options = [
                document.getElementById('opt1'),
                document.getElementById('opt2'),
                document.getElementById('opt3')
            ];
            
            // çµæœç”»é¢ç”¨
            const resultOverlay = document.getElementById('result-overlay');
            const finalScoreEl = document.getElementById('final-score');
            const rankingList = document.getElementById('overlay-ranking-list');
            const retryBtn = document.getElementById('retry-btn');
            const resetBtn = document.getElementById('reset-storage');
            const sendingMsg = document.getElementById('sending-msg');

            let score = 0;
            let timeLeft = 30;
            let timerInterval;
            let currentAnswer = 0;
            let isPlaying = false;

            const STORAGE_KEY = 'calc_ranking_v1';

            // --- ã‚²ãƒ¼ãƒ ã®ãƒ­ã‚¸ãƒƒã‚¯ ---

            function generateQuestion() {
                // 1. è¶³ã—ç®—ã‹å¼•ãç®—ã‹ã‚’æ±ºã‚ã‚‹ (0:è¶³ã—ç®—, 1:å¼•ãç®—)
                const type = Math.random() < 0.5 ? 0 : 1;
                let a, b, symbol;

                if (type === 0) {
                    // è¶³ã—ç®— (ç­”ãˆãŒ20ä»¥ä¸‹ã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´)
                    a = Math.floor(Math.random() * 15) + 1; // 1~15
                    b = Math.floor(Math.random() * (20 - a)) + 1;
                    symbol = "+";
                    currentAnswer = a + b;
                } else {
                    // å¼•ãç®— (ç­”ãˆãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã« a > b ã«ã™ã‚‹)
                    a = Math.floor(Math.random() * 19) + 2; // 2~20
                    b = Math.floor(Math.random() * (a - 1)) + 1;
                    symbol = "-";
                    currentAnswer = a - b;
                }

                // å•é¡Œã‚’è¡¨ç¤º
                questionEl.textContent = `${a} ${symbol} ${b} = ?`;

                // é¸æŠè‚¢ã‚’ä½œã‚‹ (æ­£è§£1ã¤ + ãƒ€ãƒŸãƒ¼2ã¤)
                let answers = [currentAnswer];
                
                while (answers.length < 3) {
                    // æ­£è§£ã«è¿‘ã„æ•°å­—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä½œã‚‹ (ç­”ãˆ-3 ã€œ ç­”ãˆ+3)
                    let dummy = currentAnswer + Math.floor(Math.random() * 7) - 3;
                    // ãƒ€ãƒŸãƒ¼ãŒæ­£è§£ã¨åŒã˜ã ã£ãŸã‚Šã€0ä»¥ä¸‹ã ã£ãŸã‚Šã€æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚‹å ´åˆã¯ä½œã‚Šç›´ã—
                    if (dummy !== currentAnswer && dummy > 0 && !answers.includes(dummy)) {
                        answers.push(dummy);
                    }
                }

                // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆå ´æ‰€ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ï¼‰
                answers.sort(() => Math.random() - 0.5);

                // ãƒœã‚¿ãƒ³ã«æ•°å­—ã‚’ã‚»ãƒƒãƒˆ
                options.forEach((btn, index) => {
                    btn.textContent = answers[index];
                    btn.className = "option-btn"; // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè‰²ã®å¤‰æ›´ã‚’æˆ»ã™ï¼‰
                    btn.onclick = () => checkAnswer(answers[index], btn);
                });
            }

            function checkAnswer(selectedVal, btnElement) {
                if (!isPlaying) return;

                if (selectedVal === currentAnswer) {
                    // æ­£è§£ï¼
                    score++;
                    scoreEl.textContent = score;
                    generateQuestion(); // ã™ãæ¬¡ã®å•é¡Œã¸
                } else {
                    // ä¸æ­£è§£...
                    btnElement.classList.add("wrong"); // ãƒœã‚¿ãƒ³ã‚’ä¸€ç¬ã‚°ãƒ¬ãƒ¼ã«ã—ã¦æºã‚‰ã™
                }
            }

            function startGame() {
                score = 0;
                timeLeft = 30; // 30ç§’åˆ¶é™
                isPlaying = true;
                scoreEl.textContent = 0;
                timerEl.textContent = 30;
                startBtn.disabled = true;

                generateQuestion();

                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function endGame() {
                clearInterval(timerInterval);
                isPlaying = false;
                
                // ç”»é¢ã‚’æ›´æ–°ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                finalScoreEl.textContent = score + " å•";
                saveAndShowRanking(score);
                resultOverlay.style.display = "flex";
            }

            // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ (ã‚¹ã‚³ã‚¢ãŒé«˜ã„é †) ---
            function saveAndShowRanking(newScore) {
                // 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸é€ä¿¡
                if (typeof sendData === 'function') {
                    sendingMsg.textContent = "è¨˜éŒ²ä¸­...";
                    sendData("è¨ˆç®—ãƒ‰ãƒªãƒ«", newScore);
                    setTimeout(() => { sendingMsg.textContent = "âœ… è¨˜éŒ²å®Œäº†"; }, 1000);
                }

                // 2. ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                let scores = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
                scores.push(newScore);
                scores.sort((a, b) => b - a); // å¤§ãã„é † (é™é †)
                scores = scores.slice(0, 5); // ãƒˆãƒƒãƒ—5
                localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));

                // HTMLç”Ÿæˆ
                let html = "";
                if (scores.length === 0) html = "<li>è¨˜éŒ²ãªã—</li>";
                else {
                    scores.forEach((s, i) => {
                        let rankClass = i === 0 ? 'class="rank-1"' : '';
                        let icon = i === 0 ? 'ğŸ‘‘' : (i + 1) + 'ä½';
                        html += `<li ${rankClass}>${icon} : ${s} å•æ­£è§£</li>`;
                    });
                }
                rankingList.innerHTML = html;
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            startBtn.addEventListener('click', startGame);
            
            retryBtn.addEventListener('click', () => {
                resultOverlay.style.display = "none";
                startBtn.disabled = false;
                scoreEl.textContent = 0;
                timerEl.textContent = 30;
                questionEl.textContent = "? + ? = ?";
                options.forEach(btn => btn.textContent = "-");
            });

            resetBtn.addEventListener('click', () => {
                if(confirm("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY);
                    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
                    resultOverlay.style.display = "none";
                    startBtn.disabled = false;
                }
            });
        };
    </script>
</body>
</html>